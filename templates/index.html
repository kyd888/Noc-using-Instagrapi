<!DOCTYPE html>
<html>
<head>
    <title>Instagram Monitor (Version {{ version }})</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Instagram Monitor (Version {{ version }})</h1>
    <form id="login-form" method="POST">
        <label for="insta_username">Instagram Username:</label><br>
        <input type="text" id="insta_username" name="insta_username"><br><br>
        <label for="insta_password">Instagram Password:</label><br>
        <input type="password" id="insta_password" name="insta_password"><br><br>
        <button type="submit">Login</button>
    </form>
    
    <form id="monitor-form" style="display:none;">
        <label for="target_username">Target Username:</label><br>
        <input type="text" id="target_username" name="target_username"><br><br>
        <button type="submit">Start Monitoring</button>
        <button type="button" id="stop-monitoring">Stop Monitoring</button>
    </form>

    <h2>Status</h2>
    <div id="status">Not monitoring.</div>

    <h2>Latest Post URLs</h2>
    <div id="latest_post_urls">No posts yet.</div>
    <div id="last_refresh_time">Last refresh time: Not yet refreshed.</div>

    <h2>Refresh Messages</h2>
    <div id="refresh_messages"></div>

    <h2>Comments</h2>
    <div id="comments"></div>

    <script>
        let monitoring = false;

        $(document).ready(function() {
            $('#login-form').submit(function(event) {
                event.preventDefault();
                $.post('/login', $(this).serialize(), function(response) {
                    alert(response.status);
                    if (response.status === 'Login successful') {
                        $('#login-form').hide();
                        $('#monitor-form').show();
                        $('#status').text('Logged in. You can now start monitoring.');
                    }
                });
            });

            $('#monitor-form').submit(function(event) {
                event.preventDefault();
                $.post('/start_monitoring', $(this).serialize(), function(response) {
                    alert(response.status);
                    if (response.status === 'Monitoring started') {
                        $('#status').text('Monitoring has started.');
                        updatePostUrls(response.post_urls);
                        monitoring = true;
                        checkStatus();
                    }
                });
            });

            $('#stop-monitoring').click(function() {
                $.post('/stop_monitoring', function(response) {
                    alert(response.status);
                    $('#status').text('Monitoring has stopped.');
                    monitoring = false;
                });
            });

            function checkStatus() {
                if (monitoring) {
                    setTimeout(function() {
                        $.get('/get_comments', function(data) {
                            console.log('Fetched comments data:', data);
                            $('#comments').empty();
                            for (let postId in data.comments) {
                                $('#comments').append('<h3>For post ' + postId + ':</h3>');
                                if (data.comments[postId].length > 0) {
                                    data.comments[postId].forEach(function(comment) {
                                        $('#comments').append('<p>User: ' + comment[0] + '<br>Comment: ' + comment[1] + '<br>Time: ' + comment[2] + '</p><hr>');
                                    });
                                } else {
                                    $('#comments').append('<p>No comments yet.</p>');
                                }
                            }
                            $('#status').text('Still monitoring... ' + new Date().toLocaleTimeString());
                        });

                        $.get('/get_post_urls', function(data) {
                            updatePostUrls(data.post_urls);
                            if (data.last_refresh_time) {
                                $('#last_refresh_time').text('Last refresh time: ' + data.last_refresh_time);
                            } else {
                                $('#last_refresh_time').text('Last refresh time: Not yet refreshed.');
                            }
                            updateRefreshMessages(data.refresh_messages);
                        });

                        checkStatus();
                    }, 5000);
                }
            }

            function updatePostUrls(postUrls) {
                $('#latest_post_urls').empty();
                postUrls.forEach(function(post) {
                    $('#latest_post_urls').append('<p><a href="' + post.url + '" target="_blank">' + post.url + '</a> (' + post.id + ')</p>');
                });
            }

            function updateRefreshMessages(message) {
                $('#refresh_messages').text(message); // Set the message as text
            }
        });
    </script>
</body>
</html>
